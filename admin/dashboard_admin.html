<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Free Parkir</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:Arial,sans-serif; }
body { background:#f4f6f9; min-height:100vh; }
h2 { text-align:center; margin:15px 0; }
.container { width:95%; max-width:1000px; margin:auto; }

table { width:100%; border-collapse:collapse; background:white; font-size:13px; }
th { background:#2c3e50; color:white; padding:10px; }
td { padding:8px; text-align:center; vertical-align:middle; }
tr:nth-child(even){ background:#f2f2f2; }

.btn { padding:5px 10px; border-radius:5px; color:white; border:none; cursor:pointer; }
.btn-hapus { background:red; }
.status-aktif { color:green; font-weight:bold; }
.status-selesai { color:gray; font-weight:bold; }

textarea { width:180px; height:60px; resize:vertical; }

input, select, button { font-size:13px; padding:5px; margin:3px 0; border-radius:5px; }
button { cursor:pointer; }
@media(max-width:600px){
    table, th, td { font-size:11px; }
    textarea { width:140px; height:50px; }
}
</style>
</head>
<body>

<h2>KELOLA ADMIN</h2>

<div class="container">
<label>Cari Nama / Plat:</label>
<input type="text" id="cari" placeholder="Cari...">
<label>Periode Bulan:</label>
<input type="month" id="bulan">
<button onclick="loadData()">Filter</button>

<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Keterangan</th>
<th>Status</th>
<th>Catatan Admin</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="data-table"></tbody>
</table>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
// ======= Render Data ke Tabel =======
const tableBody = document.getElementById('data-table');

function renderRow(docData, docId){
    const tr = document.createElement('tr');

    // Status aktif/selesai
    const today = new Date();
    const awal = new Date(docData.periode_awal);
    const akhir = new Date(docData.periode_akhir);
    let statusText = "-";
    if(today >= awal && today <= akhir) statusText = "<span class='status-aktif'>Aktif</span>";
    else if(today > akhir) statusText = "<span class='status-selesai'>Selesai</span>";

    tr.innerHTML = `
        <td>${docData.jenis_pengajuan}</td>
        <td>${docData.nama}</td>
        <td>${docData.departement}</td>
        <td>${docData.nomor_plat}</td>
        <td>${docData.jenis_kendaraan||''}</td>
        <td>${docData.periode_awal} s/d ${docData.periode_akhir}</td>
        <td>${docData.keterangan||''}</td>
        <td>${statusText}</td>
        <td>
            <textarea class="catatan-admin" data-id="${docId}">${docData.catatan_admin||''}</textarea>
        </td>
        <td>
            <button class="btn btn-hapus" data-id="${docId}">Hapus</button>
        </td>
    `;
    tableBody.appendChild(tr);
}

// ======= Load Data Realtime =======
let unsubscribe = null;
function loadData(){
    const cari = document.getElementById('cari').value.toLowerCase();
    const bulan = document.getElementById('bulan').value;

    // Hentikan listener sebelumnya
    if(unsubscribe) unsubscribe();

    let q = db.collection('pengajuan').orderBy('timestamp','desc');

    unsubscribe = q.onSnapshot(snapshot=>{
        tableBody.innerHTML='';
        snapshot.forEach(doc=>{
            const d = doc.data();
            // Filter manual karena Firebase tidak mendukung LIKE di client
            let match = true;
            if(cari){
                match = Object.values(d).some(v=>String(v).toLowerCase().includes(cari));
            }
            if(bulan){
                const bln = d.periode_awal.substring(0,7);
                if(bln !== bulan) match = false;
            }
            if(match) renderRow(d, doc.id);
        });
        aktifkanAutoSave();
        aktifkanHapus();
    });
}

// ======= Auto Save Catatan Admin =======
function aktifkanAutoSave(){
    document.querySelectorAll('.catatan-admin').forEach(textarea=>{
        let timeout = null;
        textarea.onkeyup = ()=>{
            clearTimeout(timeout);
            timeout = setTimeout(()=>{
                const id = textarea.dataset.id;
                const catatan = textarea.value;
                db.collection('pengajuan').doc(id).update({ catatan_admin: catatan, status_admin: 'sudah di input' });
            }, 800);
        };
    });
}

// ======= Hapus Data =======
function aktifkanHapus(){
    document.querySelectorAll('.btn-hapus').forEach(btn=>{
        btn.onclick = ()=>{
            if(confirm("Yakin ingin menghapus data ini?")){
                const id = btn.dataset.id;
                db.collection('pengajuan').doc(id).delete();
            }
        };
    });
}

// ======= Auto Refresh =======
loadData();
setInterval(loadData, 10000);
</script>

</body>
</html>