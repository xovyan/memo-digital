<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Free Parkir</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif;}
body{background:#f1f4f9;min-height:100vh;}
h2{text-align:center;padding:20px 0;background:#2c3e50;color:white;}
.container{width:95%;max-width:1200px;margin:20px auto;background:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.05);}
.summary-box{background:#eafaf1;border:2px solid #2ecc71;padding:15px;border-radius:10px;margin-bottom:20px;text-align:center;font-size:18px;font-weight:bold;color:#27ae60;}
.table-wrapper{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:1000px;}
th{background:#34495e;color:white;padding:12px;text-align:center;}
td{padding:10px;text-align:center;border-bottom:1px solid #eee;}
.status-aktif{color:green;font-weight:bold;}
.status-selesai{color:gray;font-weight:bold;}
.status-sudah{color:blue;font-weight:bold;}
textarea{width:180px;height:65px;border-radius:6px;border:1px solid #ccc;}
.btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-size:12px;}
.btn-hapus{background:#e74c3c;color:white;}
.btn-sudah{background:#27ae60;color:white;margin-bottom:5px;}
</style>
</head>

<body>

<h2>KELOLA ADMIN</h2>

<div class="container">

<div class="summary-box">
TOTAL PARKIR AKTIF SAAT INI :
<span id="total-aktif">0</span>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Keterangan</th>
<th>Status</th>
<th>Status Admin</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="data-table"></tbody>
</table>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCaPM6CNaiK-VZYR0-dkrrYMANiWi8pUGw",
  authDomain: "memodigital-57c0c.firebaseapp.com",
  projectId: "memodigital-57c0c",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tableBody = document.getElementById('data-table');
const totalAktifEl = document.getElementById('total-aktif');

function renderRow(docData, docId){
    const tr = document.createElement('tr');
    const today = new Date();
    const awal = new Date(docData.periode_awal);
    const akhir = new Date(docData.periode_akhir);

    let statusText="-";
    if(today>=awal && today<=akhir)
        statusText="<span class='status-aktif'>Aktif</span>";
    else if(today>akhir)
        statusText="<span class='status-selesai'>Selesai</span>";

    // ✅ PLAT JADI BARIS BARU
    let platFormatted="-";
    if(docData.nomor_plat){
        platFormatted = docData.nomor_plat
            .split(',')
            .map(p=>p.trim())
            .join('<br>');
    }

    // ✅ STATUS ADMIN
    let statusAdmin = docData.status_admin==="Sudah"
        ? "<span class='status-sudah'>Sudah</span>"
        : "Belum";

    tr.innerHTML = `
        <td>${docData.jenis_pengajuan||''}</td>
        <td>${docData.nama||''}</td>
        <td>${docData.departement||''}</td>
        <td>${platFormatted}</td>
        <td>${docData.jenis_kendaraan||''}</td>
        <td>${docData.periode_awal} s/d ${docData.periode_akhir}</td>
        <td>${docData.keterangan||''}</td>
        <td>${statusText}</td>
        <td>${statusAdmin}</td>
        <td>
            ${
                docData.status_admin==="Sudah"
                ? ""
                : `<button class="btn btn-sudah" onclick="tandaiSudah('${docId}')">Sudah Input</button>`
            }
            <button class="btn btn-hapus" onclick="hapusData('${docId}')">Hapus</button>
        </td>
    `;
    tableBody.appendChild(tr);
}

function tandaiSudah(id){
    db.collection('pengajuan').doc(id).update({
        status_admin:"Sudah"
    });
}

function hapusData(id){
    if(confirm("Yakin ingin menghapus data ini?")){
        db.collection('pengajuan').doc(id).delete();
    }
}

function loadData(){
    db.collection('pengajuan')
    .orderBy('timestamp','desc')
    .onSnapshot(snapshot=>{
        tableBody.innerHTML='';
        let totalAktif=0;
        const today=new Date();

        snapshot.forEach(doc=>{
            const d=doc.data();
            const awal=new Date(d.periode_awal);
            const akhir=new Date(d.periode_akhir);
            if(today>=awal && today<=akhir) totalAktif++;
            renderRow(d,doc.id);
        });

        totalAktifEl.textContent=totalAktif;
    });
}

loadData();
</script>

</body>
</html>