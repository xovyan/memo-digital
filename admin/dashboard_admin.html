<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Free Parkir</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif;}
body{background:#f1f4f9;min-height:100vh;}

h2{
    text-align:center;
    padding:20px 0;
    background:#2c3e50;
    color:white;
}

.container{
    width:95%;
    max-width:1200px;
    margin:20px auto;
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 15px rgba(0,0,0,0.05);
}

.summary-box{
    background:#eafaf1;
    border:2px solid #2ecc71;
    padding:15px;
    border-radius:10px;
    margin-bottom:20px;
    text-align:center;
    font-size:18px;
    font-weight:bold;
    color:#27ae60;
}

.table-wrapper{overflow-x:auto;}

table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
    min-width:1000px;
}

th{
    background:#34495e;
    color:white;
    padding:12px;
    text-align:center;
}

td{
    padding:10px;
    text-align:center;
    border-bottom:1px solid #eee;
}

.status-aktif{color:green;font-weight:bold;}
.status-selesai{color:gray;font-weight:bold;}
.status-sudah{color:blue;font-weight:bold;}

textarea{
    width:160px;
    height:60px;
}

.btn{
    padding:6px 12px;
    border-radius:6px;
    border:none;
    cursor:pointer;
    font-size:12px;
}

.btn-hapus{background:#e74c3c;color:white;}
.btn-sudah{background:#27ae60;color:white;}
</style>
</head>

<body>

<h2>KELOLA ADMIN</h2>

<div class="container">

<div class="summary-box">
TOTAL PARKIR AKTIF SAAT INI :
<span id="total-aktif">0</span>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Status</th>
<th>Status Admin</th>
<th>Catatan</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="data-table"></tbody>
</table>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCaPM6CNaiK-VZYR0-dkrrYMANiWi8pUGw",
  authDomain: "memodigital-57c0c.firebaseapp.com",
  projectId: "memodigital-57c0c",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tableBody = document.getElementById('data-table');
const totalAktifEl = document.getElementById('total-aktif');

db.collection('pengajuan')
.orderBy('timestamp','desc')
.onSnapshot(snapshot=>{

    tableBody.innerHTML='';
    let totalAktif=0;
    const today=new Date();

    snapshot.forEach(doc=>{
        const d=doc.data();

        // SPLIT PLAT JIKA ADA KOMA
        let daftarPlat = [];
        if(d.nomor_plat){
            daftarPlat = d.nomor_plat.split(',').map(p=>p.trim());
        }

        daftarPlat.forEach(plat=>{

            const awal=new Date(d.periode_awal);
            const akhir=new Date(d.periode_akhir);

            let statusText="-";
            if(today>=awal && today<=akhir){
                statusText="<span class='status-aktif'>Aktif</span>";
                totalAktif++;
            }
            else if(today>akhir){
                statusText="<span class='status-selesai'>Selesai</span>";
            }

            let statusAdminText = d.status_admin==="Sudah"
                ? "<span class='status-sudah'>Sudah</span>"
                : "-";

            const tr=document.createElement('tr');

            tr.innerHTML=`
                <td>${d.jenis_pengajuan}</td>
                <td>${d.nama}</td>
                <td>${d.departement}</td>
                <td>${plat}</td>
                <td>${d.jenis_kendaraan||''}</td>
                <td>${d.periode_awal} s/d ${d.periode_akhir}</td>
                <td>${statusText}</td>
                <td>${statusAdminText}</td>
                <td>
                    <textarea data-id="${doc.id}">${d.catatan_admin||''}</textarea>
                </td>
                <td>
                    ${
                        d.status_admin==="Sudah"
                        ? ""
                        : `<button class="btn btn-sudah" onclick="tandaiSudah('${doc.id}')">Sudah Diinput</button>`
                    }
                    <button class="btn btn-hapus" onclick="hapusData('${doc.id}')">Hapus</button>
                </td>
            `;

            tableBody.appendChild(tr);
        });
    });

    totalAktifEl.textContent=totalAktif;
});

function tandaiSudah(id){
    db.collection('pengajuan')
      .doc(id)
      .update({
        status_admin:"Sudah"
      });
    alert("Berhasil ditandai Sudah");
}

function hapusData(id){
    if(confirm("Yakin hapus data?")){
        db.collection('pengajuan').doc(id).delete();
    }
}
</script>

</body>
</html>