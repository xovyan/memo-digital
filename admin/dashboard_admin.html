<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#f4f6f9}
header{background:#2c3e50;color:#fff;padding:15px;text-align:center;font-size:20px}
.container{width:95%;max-width:1200px;margin:20px auto;background:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.05);}
.summary-box{background:#eafaf1;border:2px solid #2ecc71;padding:15px;border-radius:10px;margin-bottom:20px;text-align:center;font-size:18px;font-weight:bold;color:#27ae60;}
.table-wrapper{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:13px}
th{background:#34495e;color:white;padding:12px}
td{padding:10px;text-align:center;border-bottom:1px solid #eee}
.btn{padding:6px 10px;border-radius:6px;border:none;cursor:pointer;font-size:12px}
.btn-sudah{background:#27ae60;color:white;margin-bottom:5px}
.btn-hapus{background:#e74c3c;color:white}
.status-baru{color:red;font-weight:bold}
.status-sudah{color:green;font-weight:bold}
</style>
</head>
<body>

<h2>KELOLA ADMIN</h2>

<div class="container">
<div class="summary-box">
TOTAL PARKIR AKTIF SAAT INI : <span id="totalAktif">0</span> | TOTAL BELUM INPUT : <span id="totalBelum">0</span>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Keterangan</th>
<th>Status</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCaPM6CNaiK-VZYR0-dkrrYMANiWi8pUGw",
  authDomain: "memodigital-57c0c.firebaseapp.com",
  projectId: "memodigital-57c0c",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tableBody = document.getElementById('dataTable');
const totalAktifEl = document.getElementById('totalAktif');
const totalBelumEl = document.getElementById('totalBelum');

function renderRow(docId,data,index){
    const today = new Date();
    const awal = new Date(data.periode_awal);
    const akhir = new Date(data.periode_akhir);

    let statusText = (today>=awal && today<=akhir) ? "Aktif" : "Selesai";

    // Ambil status plat per index
    let statusPlat = Array.isArray(data.status_admin_per_plat) ? data.status_admin_per_plat[index] : "Belum";

    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td>${data.jenis_pengajuan||""}</td>
        <td>${data.nama||""}</td>
        <td>${data.departement||""}</td>
        <td>${data.nomor_plat[index]||""}</td>
        <td>${data.jenis_kendaraan||""}</td>
        <td>${data.periode_awal||""} s/d ${data.periode_akhir||""}</td>
        <td>${data.keterangan||""}</td>
        <td>${statusPlat==="Sudah"?'<span class="status-sudah">Sudah</span>':'<span class="status-baru">Belum</span>'}</td>
        <td>
        ${statusPlat==="Belum"?`<button class="btn btn-sudah" onclick="tandaiSudah('${docId}',${index})">Sudah Input</button>`:""}
        </td>
    `;
    tableBody.appendChild(tr);
}

function tandaiSudah(docId,index){
    const docRef = db.collection("pengajuan").doc(docId);
    docRef.get().then(docSnap=>{
        if(docSnap.exists){
            let data = docSnap.data();
            let statusPlat = Array.isArray(data.status_admin_per_plat)?data.status_admin_per_plat:[];
            statusPlat[index] = "Sudah";
            docRef.update({status_admin_per_plat:statusPlat});
        }
    });
}

function loadData(){
    db.collection("pengajuan").onSnapshot(snapshot=>{
        tableBody.innerHTML="";
        let totalAktif=0;
        let totalBelum=0;
        const today = new Date();

        snapshot.forEach(doc=>{
            const data = doc.data();
            const awal = new Date(data.periode_awal);
            const akhir = new Date(data.periode_akhir);
            const daftarPlat = Array.isArray(data.nomor_plat)?data.nomor_plat:[data.nomor_plat];
            const statusPlat = Array.isArray(data.status_admin_per_plat)?data.status_admin_per_plat:daftarPlat.map(()=> "Belum");

            if(today>=awal && today<=akhir) totalAktif++;

            daftarPlat.forEach((plat,index)=>{
                renderRow(doc.id,data,index);
                if(statusPlat[index]==="Belum") totalBelum++;
            });
        });

        totalAktifEl.textContent = totalAktif;
        totalBelumEl.textContent = totalBelum;
    });
}

loadData();
</script>
</body>
</html>