<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Filter & Excel</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif;}
body{background:#f1f4f9;}
h2{text-align:center;padding:20px;background:#2c3e50;color:white;}
.container{width:95%;max-width:1200px;margin:20px auto;background:white;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.05);}
.summary-box{background:#eafaf1;border:2px solid #2ecc71;padding:15px;border-radius:10px;margin-bottom:10px;text-align:center;font-size:16px;font-weight:bold;color:#27ae60;word-break:break-word;}
.filters{margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;}
.filters input{padding:8px;border-radius:6px;border:1px solid #ccc;flex:1;}
.filters button{padding:8px 12px;border-radius:6px;border:none;background:#3498db;color:white;cursor:pointer;}
.table-wrapper{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{background:#34495e;color:white;padding:10px;white-space:nowrap;}
td{padding:8px;text-align:center;border-bottom:1px solid #eee;vertical-align:middle;word-break:break-word;}
.status-aktif{color:green;font-weight:bold;}
.status-selesai{color:gray;font-weight:bold;}
.status-sudah{color:blue;font-weight:bold;}
.status-baru{color:red;font-weight:bold;}
.btn{padding:5px 8px;border-radius:6px;border:none;cursor:pointer;font-size:12px;margin:2px;display:inline-block;}
.btn-sudah{background:#27ae60;color:white;}
.btn-hapus{background:#e74c3c;color:white;}
@media(max-width:768px){
  table, thead, tbody, th, td, tr{display:block;}
  thead tr{display:none;}
  td{position:relative;padding-left:50%;text-align:left;}
  td::before{
    position:absolute;
    top:8px;
    left:10px;
    width:45%;
    white-space:nowrap;
    font-weight:bold;
    content: attr(data-label);
  }
  td button{width:100%; margin-top:5px;}
}
</style>
</head>
<body>

<h2>ADMIN DASHBOARD - FREE PARKIR</h2>

<div class="container">

<div class="summary-box">
TOTAL PARKIR AKTIF SAAT INI : <span id="total-aktif">0</span> | TOTAL BELUM DI INPUT : <span id="total-belum">0</span>
</div>

<div class="filters">
<input type="text" id="filterNama" placeholder="Cari Nama">
<input type="text" id="filterDept" placeholder="Cari Departement">
<input type="text" id="filterPlat" placeholder="Cari Plat">
<select id="filterStatus">
<option value="">Semua Status Admin</option>
<option value="Sudah">Sudah</option>
<option value="Belum">Belum</option>
</select>
<button id="btnReset">Reset Filter</button>
<button id="btnExport">Export Excel</button>
</div>

<div class="table-wrapper">
<table id="mainTable">
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Keterangan</th>
<th>Status</th>
<th>Status Admin</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="data-table"></tbody>
</table>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCaPM6CNaiK-VZYR0-dkrrYMANiWi8pUGw",
  authDomain: "memodigital-57c0c.firebaseapp.com",
  projectId: "memodigital-57c0c",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tableBody = document.getElementById('data-table');
const totalAktifEl = document.getElementById('total-aktif');
const totalBelumEl = document.getElementById('total-belum');

let allData = [];

function renderRow(data, id){
    const today = new Date();
    const awal = new Date(data.periode_awal);
    const akhir = new Date(data.periode_akhir);

    let statusText = today >= awal && today <= akhir
        ? "<span class='status-aktif'>Aktif</span>"
        : today > akhir
            ? "<span class='status-selesai'>Selesai</span>"
            : "-";

    let platList = [];
    if(Array.isArray(data.nomor_plat)){
        platList = data.nomor_plat;
    } else if(typeof data.nomor_plat === "string"){
        platList = data.nomor_plat.split(",").map(p=>p.trim());
    }

    let statusAdmin = data.status_admin==="Sudah"
        ? "<span class='status-sudah'>Sudah</span>"
        : "<span class='status-baru'>Belum</span>";

    platList.forEach((plat,index)=>{
        const tr = document.createElement("tr");
        tr.dataset.nama = data.nama.toLowerCase();
        tr.dataset.dept = data.departement.toLowerCase();
        tr.dataset.plat = plat.toLowerCase();
        tr.dataset.status = data.status_admin;
        tr.innerHTML=`
            <td data-label="Jenis">${index===0?data.jenis_pengajuan:''}</td>
            <td data-label="Nama">${index===0?data.nama:''}</td>
            <td data-label="Departement">${index===0?data.departement:''}</td>
            <td data-label="Plat">${plat||''}</td>
            <td data-label="Kendaraan">${index===0?data.jenis_kendaraan:''}</td>
            <td data-label="Periode">${index===0?data.periode_awal+' s/d '+data.periode_akhir:''}</td>
            <td data-label="Keterangan">${index===0?data.keterangan:''}</td>
            <td data-label="Status">${index===0?statusText:''}</td>
            <td data-label="Status Admin">${index===0?statusAdmin:''}</td>
            <td data-label="Aksi">
                ${index===0?(data.status_admin==="Sudah"?"":`<button class="btn btn-sudah" onclick="tandaiSudah('${id}')">Sudah Input</button>`):''}
                ${index===0?`<button class="btn btn-hapus" onclick="hapusData('${id}')">Hapus</button>`:''}
            </td>
        `;
        tableBody.appendChild(tr);
    });
}

function tandaiSudah(id){
    db.collection("pengajuan").doc(id).update({status_admin:"Sudah"});
}

function hapusData(id){
    if(confirm("Yakin hapus data?")){
        db.collection("pengajuan").doc(id).delete();
    }
}

function loadData(){
    db.collection("pengajuan").orderBy("timestamp","desc").get().then(snapshot=>{
        tableBody.innerHTML="";
        allData = [];
        let totalAktif=0;
        let totalBelum=0;
        const today = new Date();

        if(snapshot.empty){
            tableBody.innerHTML="<tr><td colspan='10'>Belum ada data</td></tr>";
            totalAktifEl.textContent=0;
            totalBelumEl.textContent=0;
            return;
        }

        snapshot.forEach(doc=>{
            const d = doc.data();
            d.id = doc.id;
            allData.push(d);

            const awal = new Date(d.periode_awal);
            const akhir = new Date(d.periode_awal);
            if(today >= awal && today <= akhir) totalAktif++;
            if(d.status_admin!=="Sudah") totalBelum++;

            renderRow(d, doc.id);
        });

        totalAktifEl.textContent=totalAktif;
        totalBelumEl.textContent=totalBelum;
    });
}

loadData();

/* FILTER */
function applyFilter(){
    const nama = document.getElementById('filterNama').value.toLowerCase();
    const dept = document.getElementById('filterDept').value.toLowerCase();
    const plat = document.getElementById('filterPlat').value.toLowerCase();
    const status = document.getElementById('filterStatus').value;

    tableBody.querySelectorAll('tr').forEach(tr=>{
        const show = 
            (!nama || tr.dataset.nama.includes(nama)) &&
            (!dept || tr.dataset.dept.includes(dept)) &&
            (!plat || tr.dataset.plat.includes(plat)) &&
            (!status || tr.dataset.status === status);
        tr.style.display = show ? '' : 'none';
    });
}

document.getElementById('filterNama').addEventListener('input', applyFilter);
document.getElementById('filterDept').addEventListener('input', applyFilter);
document.getElementById('filterPlat').addEventListener('input', applyFilter);
document.getElementById('filterStatus').addEventListener('change', applyFilter);

document.getElementById('btnReset').addEventListener('click', ()=>{
    document.getElementById('filterNama').value='';
    document.getElementById('filterDept').value='';
    document.getElementById('filterPlat').value='';
    document.getElementById('filterStatus').value='';
    applyFilter();
});

/* EXPORT EXCEL */
document.getElementById('btnExport').addEventListener('click', ()=>{
    const wb = XLSX.utils.book_new();
    const ws_data = [];
    const headers = ['Jenis','Nama','Departement','Plat','Kendaraan','Periode','Keterangan','Status','Status Admin'];
    ws_data.push(headers);

    tableBody.querySelectorAll('tr').forEach(tr=>{
        if(tr.style.display === 'none') return;
        const row=[];
        tr.querySelectorAll('td').forEach(td=>{
            row.push(td.textContent.trim());
        });
        ws_data.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Pengajuan");
    XLSX.writeFile(wb, "Pengajuan.xlsx");
});
</script>

</body>
</html>