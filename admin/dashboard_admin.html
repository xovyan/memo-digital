<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Free Parkir</title>
<style>
body{
    font-family: Arial;
    background:#f4f6f9;
    margin:0;
    padding:0;
}
h2{
    text-align:center;
    margin-top:15px;
}
.container{
    width:95%;
    margin:auto;
    overflow-x:auto;
}

table{
    width:100%;
    border-collapse:collapse;
    background:white;
    min-width:800px;
}
th{
    background:#2c3e50;
    color:white;
    padding:10px;
    text-align:center;
}
td{
    padding:8px;
    text-align:center;
}
tr:nth-child(even){background:#f2f2f2;}

.btn{
    padding:5px 10px;
    border-radius:5px;
    color:white;
    border:none;
    cursor:pointer;
}
.btn-hapus{background:red;}
.btn-input{background:green;}
.status-aktif{color:green;font-weight:bold;}
.status-selesai{color:gray;font-weight:bold;}
textarea{
    width:180px;
    height:60px;
    resize:vertical;
}
.filter-group{
    margin-bottom:15px;
}
.filter-group input, .filter-group button{
    padding:6px 10px;
    margin-right:5px;
}
</style>
</head>
<body>

<h2>KELOLA ADMIN</h2>

<div class="container">
<div class="filter-group">
    <input type="text" id="cari" placeholder="Cari Nama / Plat">
    <input type="month" id="bulan">
    <button onclick="loadData()">Filter</button>
</div>

<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Keterangan</th>
<th>Status</th>
<th>Catatan Admin</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="data-table"></tbody>
</table>
</div>

<script type="module">
import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { app } from "./firebase-config.js";

const db = getFirestore(app);
const colRef = collection(db, "pengajuan");
const tableBody = document.getElementById("data-table");

// Render satu row
function renderRow(docData, docId){
    const tr = document.createElement("tr");

    const today = new Date();
    const awal = new Date(docData.periode_awal);
    const akhir = new Date(docData.periode_akhir);

    let statusText = "-";
    let statusClass = "";
    if(today >= awal && today <= akhir){
        statusText = "Aktif";
        statusClass = "status-aktif";
    }else if(today > akhir){
        statusText = "Selesai";
        statusClass = "status-selesai";
    }

    tr.innerHTML = `
        <td>${docData.jenis_pengajuan}</td>
        <td>${docData.nama_karyawan}</td>
        <td>${docData.departement}</td>
        <td>${docData.nomor_plat}</td>
        <td>${docData.jenis_kendaraan}</td>
        <td>${docData.periode_awal} s/d ${docData.periode_akhir}</td>
        <td>${docData.keterangan}</td>
        <td class="${statusClass}">${statusText}</td>
        <td><textarea class="catatan-admin" data-id="${docId}">${docData.catatan_admin || ""}</textarea></td>
        <td>
            <button class="btn btn-input" onclick="markDone('${docId}')">Sudah di Input</button>
            <button class="btn btn-hapus" onclick="hapusData('${docId}')">Hapus</button>
        </td>
    `;
    tableBody.appendChild(tr);
}

// Auto-save catatan admin
function autoSave(){
    document.querySelectorAll('.catatan-admin').forEach(textarea=>{
        let timeout=null;
        textarea.addEventListener('keyup', ()=>{
            clearTimeout(timeout);
            timeout = setTimeout(async ()=>{
                const id = textarea.getAttribute('data-id');
                const catatan = textarea.value;
                const docRef = doc(db, "pengajuan", id);
                await updateDoc(docRef, { catatan_admin: catatan });
            },800);
        });
    });
}

// Tombol "Sudah di Input"
window.markDone = async function(id){
    const docRef = doc(db, "pengajuan", id);
    await updateDoc(docRef, { status_admin: "sudah di input" });
    alert("Status sudah di input admin");
}

// Hapus data
window.hapusData = async function(id){
    if(confirm("Yakin ingin menghapus data ini?")){
        await deleteDoc(doc(db, "pengajuan", id));
        loadData();
    }
}

// Filter
function filterData(allDocs){
    const cari = document.getElementById('cari')?.value.toLowerCase() || "";
    const bulan = document.getElementById('bulan')?.value || "";

    return allDocs.filter(docData=>{
        let matchCari=true, matchBulan=true;
        if(cari){
            matchCari = Object.values(docData).some(val=>String(val).toLowerCase().includes(cari));
        }
        if(bulan){
            const docMonth = docData.periode_awal.split('-').slice(0,2).join('-'); // YYYY-MM
            matchBulan = docMonth === bulan;
        }
        return matchCari && matchBulan;
    });
}

// Load data realtime
function loadData(){
    onSnapshot(query(colRef, orderBy("periode_awal", "desc")), snapshot=>{
        tableBody.innerHTML="";
        const docs = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
        const filtered = filterData(docs);
        filtered.forEach(d=>renderRow(d, d.id));
        autoSave();
    });
}

// Event filter
document.getElementById("cari")?.addEventListener('input', loadData);
document.getElementById("bulan")?.addEventListener('input', loadData);

// Init load
loadData();
</script>

</body>
</html>