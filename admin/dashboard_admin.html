<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Free Parkir</title>
<style>
body{
    font-family: Arial;
    background:#f4f6f9;
    margin:0;
    padding:0;
}
h2{
    text-align:center;
    margin:15px 0;
}
.container{
    width:95%;
    margin:auto;
}

.filter-group{
    display:flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom:10px;
}
.filter-group input, .filter-group button{
    flex: 1 1 45%;
    padding:8px;
    font-size:14px;
}

.card{
    background:white;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
    margin-bottom:10px;
    padding:10px;
}
.card-row{
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-bottom:5px;
}
.card-row span{
    font-weight:bold;
}
textarea{
    width:100%;
    height:50px;
    resize:vertical;
    margin-bottom:5px;
}
.btn{
    padding:5px 10px;
    border:none;
    border-radius:5px;
    color:white;
    cursor:pointer;
    margin-right:5px;
}
.btn-hapus{background:red;}
.btn-input{background:green;}
.status-aktif{color:green;font-weight:bold;}
.status-selesai{color:gray;font-weight:bold;}
</style>
</head>
<body>

<h2>KELOLA ADMIN</h2>

<div class="container">
<div class="filter-group">
    <input type="text" id="cari" placeholder="Cari Nama / Plat">
    <input type="month" id="bulan">
    <button onclick="loadData()">Filter</button>
</div>

<div id="data-cards"></div>
</div>

<script type="module">
import { getFirestore, collection, onSnapshot, doc, updateDoc, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { app } from "./firebase-config.js";

const db = getFirestore(app);
const colRef = collection(db, "pengajuan");
const dataCards = document.getElementById("data-cards");

// Render card
function renderCard(docData, docId){
    const today = new Date();
    const awal = new Date(docData.periode_awal);
    const akhir = new Date(docData.periode_akhir);

    let statusText = "-";
    let statusClass = "";
    if(today >= awal && today <= akhir){
        statusText = "Aktif";
        statusClass = "status-aktif";
    }else if(today > akhir){
        statusText = "Selesai";
        statusClass = "status-selesai";
    }

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
        <div class="card-row"><span>Jenis:</span> ${docData.jenis_pengajuan}</div>
        <div class="card-row"><span>Nama:</span> ${docData.nama_karyawan}</div>
        <div class="card-row"><span>Departement:</span> ${docData.departement}</div>
        <div class="card-row"><span>Plat:</span> ${docData.nomor_plat}</div>
        <div class="card-row"><span>Kendaraan:</span> ${docData.jenis_kendaraan}</div>
        <div class="card-row"><span>Periode:</span> ${docData.periode_awal} s/d ${docData.periode_akhir}</div>
        <div class="card-row"><span>Keterangan:</span> ${docData.keterangan}</div>
        <div class="card-row ${statusClass}"><span>Status:</span> ${statusText}</div>
        <textarea class="catatan-admin" data-id="${docId}">${docData.catatan_admin || ""}</textarea>
        <div>
            <button class="btn btn-input" onclick="markDone('${docId}')">Sudah di Input</button>
            <button class="btn btn-hapus" onclick="hapusData('${docId}')">Hapus</button>
        </div>
    `;
    dataCards.appendChild(card);
}

// Auto-save catatan admin
function autoSave(){
    document.querySelectorAll('.catatan-admin').forEach(textarea=>{
        let timeout=null;
        textarea.addEventListener('keyup', ()=>{
            clearTimeout(timeout);
            timeout = setTimeout(async ()=>{
                const id = textarea.getAttribute('data-id');
                const catatan = textarea.value;
                const docRef = doc(db, "pengajuan", id);
                await updateDoc(docRef, { catatan_admin: catatan });
            },800);
        });
    });
}

// Tombol "Sudah di Input"
window.markDone = async function(id){
    const docRef = doc(db, "pengajuan", id);
    await updateDoc(docRef, { status_admin: "sudah di input" });
    alert("Status sudah di input admin");
}

// Hapus data
window.hapusData = async function(id){
    if(confirm("Yakin ingin menghapus data ini?")){
        await deleteDoc(doc(db, "pengajuan", id));
        loadData();
    }
}

// Filter
function filterData(allDocs){
    const cari = document.getElementById('cari')?.value.toLowerCase() || "";
    const bulan = document.getElementById('bulan')?.value || "";

    return allDocs.filter(docData=>{
        let matchCari=true, matchBulan=true;
        if(cari){
            matchCari = Object.values(docData).some(val=>String(val).toLowerCase().includes(cari));
        }
        if(bulan){
            const docMonth = docData.periode_awal.split('-').slice(0,2).join('-'); // YYYY-MM
            matchBulan = docMonth === bulan;
        }
        return matchCari && matchBulan;
    });
}

// Load data realtime
function loadData(){
    onSnapshot(query(colRef, orderBy("periode_awal", "desc")), snapshot=>{
        dataCards.innerHTML="";
        const docs = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
        const filtered = filterData(docs);
        filtered.forEach(d=>renderCard(d, d.id));
        autoSave();
    });
}

// Event filter
document.getElementById("cari")?.addEventListener('input', loadData);
document.getElementById("bulan")?.addEventListener('input', loadData);

// Init load
loadData();
</script>

</body>
</html>