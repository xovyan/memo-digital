<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Admin</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
body{background:#f4f6f9;}

h2{
  background:#2c3e50;
  color:white;
  text-align:center;
  padding:15px;
}

.container{
  width:95%;
  max-width:1200px;
  margin:20px auto;
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
}

.summary{
  background:#eafaf1;
  border:2px solid #2ecc71;
  padding:15px;
  border-radius:8px;
  margin-bottom:20px;
  text-align:center;
  font-weight:bold;
  color:#27ae60;
  font-size:18px;
}

.table-wrapper{overflow-x:auto;}

table{
  width:100%;
  border-collapse:collapse;
  min-width:1000px;
  font-size:13px;
}

th{
  background:#34495e;
  color:white;
  padding:10px;
}

td{
  padding:8px;
  text-align:center;
  border-bottom:1px solid #eee;
}

.status-aktif{color:green;font-weight:bold;}
.status-selesai{color:gray;font-weight:bold;}
.status-sudah{color:blue;font-weight:bold;}

textarea{
  width:140px;
  height:60px;
}

button{
  padding:6px 10px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:12px;
}

.btn-sudah{background:#27ae60;color:white;}
.btn-hapus{background:#e74c3c;color:white;}
</style>
</head>

<body>

<h2>DASHBOARD ADMIN</h2>

<div class="container">

<div class="summary">
TOTAL PARKIR AKTIF : <span id="totalAktif">0</span>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Status</th>
<th>Status Admin</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "ISI_APIKEY_KAMU",
  authDomain: "ISI_AUTHDOMAIN_KAMU",
  projectId: "ISI_PROJECTID_KAMU",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tableBody = document.getElementById("tableBody");
const totalAktifEl = document.getElementById("totalAktif");

db.collection("pengajuan")
.onSnapshot(snapshot => {

  tableBody.innerHTML = "";
  let totalAktif = 0;
  const today = new Date();

  if(snapshot.empty){
    tableBody.innerHTML = "<tr><td colspan='9'>Belum ada data</td></tr>";
    totalAktifEl.textContent = 0;
    return;
  }

  snapshot.forEach(doc => {

    const d = doc.data();

    let daftarPlat = ["-"];
    if(d.nomor_plat && d.nomor_plat !== ""){
      daftarPlat = d.nomor_plat.split(",").map(p => p.trim());
    }

    const awal = new Date(d.periode_awal);
    const akhir = new Date(d.periode_akhir);

    let aktifSudahDihitung = false;

    daftarPlat.forEach(plat => {

      let statusText = "-";

      if(today >= awal && today <= akhir){
        statusText = "<span class='status-aktif'>Aktif</span>";
        if(!aktifSudahDihitung){
          totalAktif++;
          aktifSudahDihitung = true;
        }
      }
      else if(today > akhir){
        statusText = "<span class='status-selesai'>Selesai</span>";
      }

      let statusAdminText = d.status_admin === "Sudah"
        ? "<span class='status-sudah'>Sudah</span>"
        : "-";

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${d.jenis_pengajuan || "-"}</td>
        <td>${d.nama || "-"}</td>
        <td>${d.departement || "-"}</td>
        <td>${plat}</td>
        <td>${d.jenis_kendaraan || "-"}</td>
        <td>${d.periode_awal || "-"} s/d ${d.periode_akhir || "-"}</td>
        <td>${statusText}</td>
        <td>${statusAdminText}</td>
        <td>
          ${
            d.status_admin === "Sudah"
            ? ""
            : `<button class="btn-sudah" onclick="tandaiSudah('${doc.id}')">Sudah Diinput</button>`
          }
          <button class="btn-hapus" onclick="hapusData('${doc.id}')">Hapus</button>
        </td>
      `;

      tableBody.appendChild(tr);

    });

  });

  totalAktifEl.textContent = totalAktif;

});

function tandaiSudah(id){
  db.collection("pengajuan").doc(id).update({
    status_admin: "Sudah"
  });
  alert("Berhasil ditandai Sudah");
}

function hapusData(id){
  if(confirm("Yakin hapus data?")){
    db.collection("pengajuan").doc(id).delete();
  }
}
</script>

</body>
</html>