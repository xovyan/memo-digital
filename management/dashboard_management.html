<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Management</title>
<link rel="stylesheet" href="assets/style.css">
</head>
<body>

<header>Dashboard Management</header>

<nav>
    <button class="tab-btn active" data-tab="pengajuan">Pengajuan</button>
    <button class="tab-btn" data-tab="riwayat">Riwayat</button>
    <button class="tab-btn" data-tab="ganti">Ganti Password</button>
    <button class="tab-btn" data-tab="logout">Log Out</button>
</nav>

<section id="content">

<div class="tab" id="pengajuan">
<h3>Form Pengajuan</h3>
<form id="formPengajuan">
    <select name="jenis_pengajuan" required>
        <option value="">--Pilih Jenis--</option>
        <option value="free parkir">Free Parkir</option>
        <option value="compliment">Compliment</option>
        <option value="ubah plat">Ubah Plat</option>
    </select>
    <input type="text" name="nama" placeholder="Nama" required>
    <input type="text" name="departement" placeholder="Departement" required>
    <input type="text" name="nomor_plat" placeholder="Nomor Plat (pisah koma jika banyak)" required>
    <input type="text" name="jenis_kendaraan" placeholder="Jenis Kendaraan">
    <input type="date" name="periode_awal" required>
    <input type="date" name="periode_akhir" required>
    <textarea name="keterangan" placeholder="Keterangan"></textarea>
    <button type="submit">Kirim</button>
</form>
</div>

<div class="tab" id="riwayat" style="display:none;">
<h3>Riwayat Pengajuan</h3>
<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Keterangan</th>
<th>Status Admin</th>
</tr>
</thead>
<tbody id="riwayatData"></tbody>
</table>
</div>

<div class="tab" id="ganti" style="display:none;">
<h3>Ganti Password</h3>
<form id="formGanti">
<input type="password" name="password_lama" placeholder="Password Lama" required>
<input type="password" name="password_baru" placeholder="Password Baru" required>
<button type="submit">Ganti Password</button>
</form>
</div>

<div class="tab" id="logout" style="display:none;">
<h3>Log Out</h3>
<button id="btnLogout">Keluar</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script type="module">
import { firebaseConfig, db } from './assets/firebase-config.js';
firebase.initializeApp(firebaseConfig);

// Tabs
const tabs = document.querySelectorAll('.tab-btn');
tabs.forEach(btn=>{
    btn.addEventListener('click',()=>{
        tabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab').forEach(tab=>tab.style.display='none');
        document.getElementById(btn.dataset.tab).style.display='block';
    });
});

// Form Pengajuan
document.getElementById('formPengajuan').addEventListener('submit', async e=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target).entries());
    data.status_admin = "belum"; 
    data.timestamp = firebase.firestore.FieldValue.serverTimestamp();

    // Split nomor plat jika lebih dari 1
    const nopolArr = data.nomor_plat.split(',').map(n=>n.trim()).filter(n=>n);
    try{
        for(const n of nopolArr){
            await db.collection('pengajuan').add({...data, nomor_plat: n});
        }
        alert("Pengajuan berhasil dikirim ke admin!");
        e.target.reset();
    }catch(err){
        alert("Terjadi kesalahan: "+err);
    }
});

// Riwayat Realtime
function loadRiwayat(){
    db.collection('pengajuan').orderBy('timestamp','desc')
    .onSnapshot(snapshot=>{
        const tbody = document.getElementById('riwayatData');
        tbody.innerHTML='';
        snapshot.forEach(doc=>{
            const d = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.jenis_pengajuan}</td>
                <td>${d.nama}</td>
                <td>${d.departement}</td>
                <td>${d.nomor_plat}</td>
                <td>${d.jenis_kendaraan||''}</td>
                <td>${d.periode_awal} s/d ${d.periode_akhir}</td>
                <td>${d.keterangan||''}</td>
                <td>${d.status_admin==='sudah' ? '<span class="status-sudah">Sudah di Input</span>' : '<span class="status-baru">Belum di Input</span>'}</td>
            `;
            tbody.appendChild(tr);
        });
    });
}
loadRiwayat();

// Ganti Password
document.getElementById('formGanti').addEventListener('submit', e=>{
    e.preventDefault();
    alert("Ganti password akan menggunakan Firebase Auth nanti.");
});

// Logout
document.getElementById('btnLogout').addEventListener('click', ()=>{
    localStorage.removeItem('management');
    window.location.href="login_management.html";
});
</script>
</body>
</html>