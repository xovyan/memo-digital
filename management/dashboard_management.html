<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Management</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
body{background:#f4f6f9}
header{background:#4e54c8;color:#fff;padding:15px;text-align:center;font-size:20px}
nav{display:flex;background:#fff}
nav button{
flex:1;
padding:12px;
border:none;
background:none;
font-weight:bold;
color:#4e54c8;
cursor:pointer
}
nav button.active{border-bottom:3px solid #4e54c8}
section{padding:15px}
form input,form select,form textarea,form button{
width:100%;
margin-bottom:10px;
padding:10px;
border-radius:8px;
border:1px solid #ccc;
font-size:14px
}
form button{
background:#4e54c8;
color:#fff;
font-weight:bold;
border:none;
cursor:pointer
}
.nopol-group{
display:flex;
gap:5px;
margin-bottom:5px
}
.nopol-group input{
flex:1
}
.nopol-group button{
width:35px;
background:red;
color:#fff;
border:none;
border-radius:6px;
font-weight:bold;
cursor:pointer
}
table{
width:100%;
border-collapse:collapse;
margin-top:15px;
background:#fff;
font-size:13px
}
th,td{
border:1px solid #ccc;
padding:6px;
text-align:center
}
th{background:#4e54c8;color:#fff}
.status-baru{color:red;font-weight:bold}
.status-sudah{color:green;font-weight:bold}
</style>
</head>
<body>

<header>Dashboard Management</header>

<nav>
<button class="tab-btn active" data-tab="pengajuan">Pengajuan</button>
<button class="tab-btn" data-tab="riwayat">Riwayat</button>
<button class="tab-btn" data-tab="ganti">Ganti Password</button>
<button class="tab-btn" data-tab="logout">Logout</button>
</nav>

<section>

<!-- ================= PENGAJUAN ================= -->
<div class="tab" id="pengajuan">

<form id="formPengajuan">

<select name="jenis_pengajuan" required>
<option value="">-- Pilih Jenis --</option>
<option value="free parkir">Free Parkir</option>
<option value="compliment">Compliment</option>
<option value="ubah plat">Ubah Plat</option>
</select>

<input type="text" name="nama" placeholder="Nama" required>
<input type="text" name="departement" placeholder="Departement" required>

<div id="nopolContainer"></div>
<button type="button" id="addNopol" style="background:#27ae60">+ Tambah Plat</button>

<input type="text" name="jenis_kendaraan" placeholder="Jenis Kendaraan">
<input type="date" name="periode_awal" required>
<input type="date" name="periode_akhir" required>
<textarea name="keterangan" placeholder="Keterangan"></textarea>

<button type="submit">Kirim</button>

</form>
</div>

<!-- ================= RIWAYAT ================= -->
<div class="tab" id="riwayat" style="display:none">

<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Dept</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Status</th>
</tr>
</thead>
<tbody id="riwayatData"></tbody>
</table>

</div>

<!-- ================= GANTI PASSWORD ================= -->
<div class="tab" id="ganti" style="display:none">
<form>
<input type="password" placeholder="Password Lama">
<input type="password" placeholder="Password Baru">
<button type="submit">Ganti Password</button>
</form>
</div>

<!-- ================= LOGOUT ================= -->
<div class="tab" id="logout" style="display:none">
<button onclick="location.href='login_management.html'">Keluar</button>
</div>

</section>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
apiKey: "API_KEY",
authDomain: "PROJECT_ID.firebaseapp.com",
projectId: "PROJECT_ID",
storageBucket: "PROJECT_ID.appspot.com",
messagingSenderId: "SENDER_ID",
appId: "APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>

/* ================= TAB ================= */
document.querySelectorAll(".tab-btn").forEach(btn=>{
btn.addEventListener("click",()=>{
document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
document.getElementById(btn.dataset.tab).style.display="block";
});
});

/* ================= NOMOR PLAT DINAMIS ================= */
const nopolContainer = document.getElementById("nopolContainer");

function createNopolField(){
const div = document.createElement("div");
div.className = "nopol-group";

const input = document.createElement("input");
input.type = "text";
input.name = "nomor_plat[]";
input.placeholder = "Nomor Plat";
input.required = true;

const btn = document.createElement("button");
btn.type = "button";
btn.textContent = "Ã—";
btn.onclick = ()=> div.remove();

div.appendChild(input);
div.appendChild(btn);
return div;
}

nopolContainer.appendChild(createNopolField());

document.getElementById("addNopol").addEventListener("click",()=>{
nopolContainer.appendChild(createNopolField());
});

/* ================= SUBMIT ================= */
document.getElementById("formPengajuan").addEventListener("submit",async function(e){

e.preventDefault();
const form = this;
const formData = new FormData(form);

const data = {
jenis_pengajuan: formData.get("jenis_pengajuan") || "",
nama: formData.get("nama") || "",
departement: formData.get("departement") || "",
jenis_kendaraan: formData.get("jenis_kendaraan") || "",
periode_awal: formData.get("periode_awal") || "",
periode_akhir: formData.get("periode_akhir") || "",
keterangan: formData.get("keterangan") || "",
status_admin: "belum",
timestamp: firebase.firestore.FieldValue.serverTimestamp(),
nomor_plat: []
};

document.querySelectorAll('input[name="nomor_plat[]"]').forEach(input=>{
if(input.value.trim()!==""){
data.nomor_plat.push(input.value.trim());
}
});

if(data.nomor_plat.length===0){
alert("Minimal 1 nomor plat harus diisi");
return;
}

try{
await db.collection("pengajuan").add(data);

/* ===== RESET TOTAL FORM (FIX FINAL) ===== */
form.reset();
nopolContainer.innerHTML="";
nopolContainer.appendChild(createNopolField());

alert("Data berhasil dikirim");

}catch(err){
alert("Gagal mengirim: "+err.message);
}

});

/* ================= RIWAYAT REALTIME ================= */
db.collection("pengajuan")
.orderBy("timestamp","desc")
.onSnapshot(snapshot=>{
const tbody=document.getElementById("riwayatData");
tbody.innerHTML="";
snapshot.forEach(doc=>{
const d=doc.data();
const tr=document.createElement("tr");
tr.innerHTML=`
<td>${d.jenis_pengajuan}</td>
<td>${d.nama}</td>
<td>${d.departement}</td>
<td>${Array.isArray(d.nomor_plat)?d.nomor_plat.join(", "):""}</td>
<td>${d.jenis_kendaraan||""}</td>
<td>${d.periode_awal} s/d ${d.periode_akhir}</td>
<td>${d.status_admin==="sudah di input"
?'<span class="status-sudah">Sudah</span>'
:'<span class="status-baru">Belum</span>'}</td>
`;
tbody.appendChild(tr);
});
});

</script>

</body>
</html>