<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Management</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Arial', sans-serif; }
body { background:#f4f6f9; min-height:100vh; }
header { background:#4e54c8; color:white; padding:15px; text-align:center; font-size:20px; }
nav { display:flex; justify-content:space-around; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
nav button { background:none; border:none; padding:15px; cursor:pointer; font-weight:bold; color:#4e54c8; flex:1; }
nav button.active { border-bottom:3px solid #4e54c8; }
section { padding:15px; }
form input, form select, form textarea, form button { width:100%; margin-bottom:10px; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
form button { background:#4e54c8; color:white; border:none; font-weight:bold; cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:15px; background:white; font-size:13px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#4e54c8; color:white; }
tr:nth-child(even){ background:#f2f2f2; }
.status-baru { color:red; font-weight:bold; }
.status-sudah { color:green; font-weight:bold; }
.nopol-group { display:flex; gap:5px; margin-bottom:5px; }
.nopol-group input { flex:1; }
.removeNopol { background:red; color:white; border:none; border-radius:4px; cursor:pointer; padding:0 8px; }
#addNopol { margin-bottom:10px; }
@media(max-width:600px){
    table, th, td { font-size:12px; }
    nav button { font-size:12px; padding:10px; }
}
</style>
</head>
<body>

<header>Dashboard Management</header>

<nav>
    <button class="tab-btn active" data-tab="pengajuan">Pengajuan</button>
    <button class="tab-btn" data-tab="riwayat">Riwayat Pengajuan</button>
    <button class="tab-btn" data-tab="ganti">Ganti Password</button>
    <button class="tab-btn" data-tab="logout">Log Out</button>
</nav>

<section id="content">

<!-- Pengajuan -->
<div class="tab" id="pengajuan">
<h3>Form Pengajuan</h3>
<form id="formPengajuan">

    <select name="jenis_pengajuan" required>
        <option value="">--Pilih Jenis--</option>
        <option value="free parkir">Free Parkir</option>
        <option value="compliment">Compliment</option>
        <option value="ubah plat">Ubah Plat</option>
    </select>

    <input type="text" name="nama" placeholder="Nama" required>
    <input type="text" name="departement" placeholder="Departement" required>

    <!-- Nomor Plat Dinamis -->
    <div id="nopolContainer">
        <div class="nopol-group">
            <input type="text" name="nomor_plat[]" placeholder="Nomor Plat" required>
            <button type="button" class="removeNopol" style="display:none;">×</button>
        </div>
    </div>
    <button type="button" id="addNopol">+ Tambah Plat</button>

    <input type="text" name="jenis_kendaraan" placeholder="Jenis Kendaraan">
    <input type="date" name="periode_awal" required>
    <input type="date" name="periode_akhir" required>
    <textarea name="keterangan" placeholder="Keterangan"></textarea>
    <button type="submit">Kirim</button>
</form>
</div>

<!-- Riwayat -->
<div class="tab" id="riwayat" style="display:none;">
<h3>Riwayat Pengajuan</h3>
<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Departement</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Keterangan</th>
<th>Status</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="riwayatData"></tbody>
</table>
</div>

<!-- Ganti Password -->
<div class="tab" id="ganti" style="display:none;">
<h3>Ganti Password</h3>
<form id="formGanti">
<input type="password" name="password_lama" placeholder="Password Lama" required>
<input type="password" name="password_baru" placeholder="Password Baru" required>
<button type="submit">Ganti Password</button>
</form>
</div>

<!-- Logout -->
<div class="tab" id="logout" style="display:none;">
<h3>Log Out</h3>
<button id="btnLogout">Keluar</button>
</div>

</section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
// ======= TABS =======
const tabs = document.querySelectorAll('.tab-btn');
tabs.forEach(btn=>{
    btn.addEventListener('click',()=>{
        tabs.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab').forEach(tab=>tab.style.display='none');
        document.getElementById(btn.dataset.tab).style.display='block';
    });
});

// ======= NOMOR PLAT DINAMIS =======
const addNopol = document.getElementById('addNopol');
const nopolContainer = document.getElementById('nopolContainer');

function createNopolField(value=''){
    const div = document.createElement('div');
    div.classList.add('nopol-group');
    div.innerHTML = `
        <input type="text" name="nomor_plat[]" placeholder="Nomor Plat" required value="${value}">
        <button type="button" class="removeNopol">×</button>
    `;
    div.querySelector('.removeNopol').addEventListener('click', ()=>{
        div.remove();
    });
    return div;
}

addNopol.addEventListener('click', ()=>{
    const newField = createNopolField();
    nopolContainer.appendChild(newField);
});

// ======= FORM PENGAJUAN =======
document.getElementById('formPengajuan').addEventListener('submit', async e=>{
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Convert multiple plat menjadi array
    data.nomor_plat = formData.getAll('nomor_plat[]');
    
    data.status_admin = "belum";
    data.timestamp = firebase.firestore.FieldValue.serverTimestamp();

    try{
        await db.collection('pengajuan').add(data);
        alert("Pengajuan berhasil dikirim ke admin!");
        e.target.reset();
        // reset input plat pertama saja
        nopolContainer.innerHTML = `<div class="nopol-group">
            <input type="text" name="nomor_plat[]" placeholder="Nomor Plat" required>
            <button type="button" class="removeNopol" style="display:none;">×</button>
        </div>`;
    }catch(err){
        alert("Terjadi kesalahan: "+err);
    }
});

// ======= RIWAYAT =======
function loadRiwayat(){
    db.collection('pengajuan').orderBy('timestamp','desc')
    .onSnapshot(snapshot=>{
        const tbody = document.getElementById('riwayatData');
        tbody.innerHTML='';
        snapshot.forEach(doc=>{
            const d = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.jenis_pengajuan}</td>
                <td>${d.nama}</td>
                <td>${d.departement}</td>
                <td>${Array.isArray(d.nomor_plat) ? d.nomor_plat.join(', ') : d.nomor_plat}</td>
                <td>${d.jenis_kendaraan||''}</td>
                <td>${d.periode_awal} s/d ${d.periode_akhir}</td>
                <td>${d.keterangan||''}</td>
                <td>${d.status_admin==='sudah' ? '<span class="status-sudah">Sudah di Input</span>' : '<span class="status-baru">Belum di Input</span>'}</td>
                <td>${d.status_admin==='sudah' ? '' : '<button class="hapusBtn">Hapus</button>'}</td>
            `;
            // Hanya admin bisa hapus
            const hapusBtn = tr.querySelector('.hapusBtn');
            if(hapusBtn){
                hapusBtn.addEventListener('click', async ()=>{
                    if(confirm("Yakin ingin menghapus data ini?")){
                        await db.collection('pengajuan').doc(doc.id).delete();
                    }
                });
            }
            tbody.appendChild(tr);
        });
    });
}
loadRiwayat();

// ======= GANTI PASSWORD =======
document.getElementById('formGanti').addEventListener('submit', e=>{
    e.preventDefault();
    alert("Fungsi ganti password nanti disesuaikan Firebase Auth");
});

// ======= LOGOUT =======
document.getElementById('btnLogout').addEventListener('click', ()=>{
    alert("Logout berhasil!");
    window.location.href="login_management.html";
});
</script>

</body>
</html>