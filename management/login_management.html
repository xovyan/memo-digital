<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
body{background:#f4f6f9}
header{background:#4e54c8;color:#fff;padding:15px;text-align:center;font-size:20px}
nav{display:flex;background:#fff}
nav button{flex:1;padding:12px;border:none;background:none;font-weight:bold;color:#4e54c8;cursor:pointer}
nav button.active{border-bottom:3px solid #4e54c8}
section{padding:15px}
form input,form select,form textarea,form button{width:100%;margin-bottom:10px;padding:10px;border-radius:8px;border:1px solid #ccc;font-size:14px}
form button{background:#4e54c8;color:#fff;font-weight:bold;border:none;cursor:pointer}
.nopol-group{display:flex;gap:5px;margin-bottom:5px;align-items:center}
.nopol-group input{flex:1;min-width:0}
.nopol-group button{background:red;color:#fff;border:none;border-radius:6px;width:30px;height:30px;cursor:pointer;font-size:16px;line-height:1;padding:0}
#addNopol{background:#27ae60;padding:6px 12px;font-size:14px;border-radius:6px;margin-top:5px;display:inline-block}
table{width:100%;border-collapse:collapse;margin-top:15px;background:#fff;font-size:13px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#4e54c8;color:#fff}
.status-baru{color:red;font-weight:bold}
.status-sudah{color:green;font-weight:bold}
.popup{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#16a34a;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.2);display:none;z-index:999}
.filter-area{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.filter-area input, .filter-area select, .filter-area button{padding:6px 10px;font-size:13px;border-radius:6px;border:1px solid #ccc}
.total-belum{margin-top:10px;font-weight:bold;font-size:14px}
</style>
</head>
<body>

<header>Dashboard</header>
<div class="popup" id="popup">Berhasil âœ…</div>

<!-- LOGIN -->
<div id="loginDiv" style="width:300px;margin:50px auto;padding:20px;background:white;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1)">
<h3 style="text-align:center;margin-bottom:15px">Login</h3>
<form id="loginForm">
<input type="text" id="usernameLogin" placeholder="Username" required>
<input type="password" id="passwordLogin" placeholder="Password" required>
<button type="submit">Login</button>
</form>
</div>

<!-- DASHBOARD -->
<section id="dashboard" style="display:none">

<nav>
<button class="tab-btn active" data-tab="pengajuan">Pengajuan</button>
<button class="tab-btn" data-tab="riwayat">Riwayat</button>
<button class="tab-btn" data-tab="ganti">Ganti Password</button>
<button class="tab-btn" data-tab="logout">Logout</button>
</nav>

<!-- PENGAJUAN -->
<div class="tab" id="pengajuan">
<form id="formPengajuan" autocomplete="off">
<select name="jenis_pengajuan" required>
<option value="">-- Pilih Jenis --</option>
<option value="Free Parkir">Free Parkir</option>
<option value="Compliment">Compliment</option>
<option value="Ubah Plat">Ubah Plat</option>
</select>

<input type="text" name="nama" placeholder="Nama" required>
<input type="text" name="departement" placeholder="Departement" required>

<div id="nopolContainer"></div>
<button type="button" id="addNopol">+ Tambah Plat</button>

<input type="text" name="jenis_kendaraan" placeholder="Jenis Kendaraan">
<input type="date" name="periode_awal" required>
<input type="date" name="periode_akhir" required>
<textarea name="keterangan" placeholder="Keterangan"></textarea>

<button type="submit" id="btnKirim">Kirim</button>
</form>
</div>

<!-- RIWAYAT -->
<div class="tab" id="riwayat" style="display:none">
<div class="filter-area">
<input type="text" id="cariFilter" placeholder="Cari Nama/Dept/Plat/Status">
<input type="month" id="bulanFilter">
<button onclick="loadRiwayat()">Filter</button>
<button onclick="exportExcel()">Export Excel</button>
</div>
<div class="total-belum">Total Belum Input: <span id="totalBelum">0</span></div>
<table>
<thead>
<tr>
<th>Jenis</th>
<th>Nama</th>
<th>Dept</th>
<th>Plat</th>
<th>Kendaraan</th>
<th>Periode</th>
<th>Keterangan</th>
<th>Status</th>
</tr>
</thead>
<tbody id="riwayatData"></tbody>
</table>
</div>

<!-- GANTI PASSWORD -->
<div class="tab" id="ganti" style="display:none">
<form id="gantiPassForm">
<input type="password" id="oldPass" placeholder="Password Lama" required>
<input type="password" id="newPass" placeholder="Password Baru" required>
<button type="submit">Ganti Password</button>
</form>
</div>

<div class="tab" id="logout" style="display:none">
<button id="logoutBtn">Keluar</button>
</div>

</section>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const firebaseConfig = {
 apiKey: "AIzaSyCaPM6CNaiK-VZYR0-dkrrYMANiWi8pUGw",
 authDomain: "memodigital-57c0c.firebaseapp.com",
 projectId: "memodigital-57c0c",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* LOGIN */
const loginDiv = document.getElementById("loginDiv");
const dashboard = document.getElementById("dashboard");
const loginForm = document.getElementById("loginForm");

loginForm.addEventListener("submit", async (e)=>{
 e.preventDefault();
 const username = document.getElementById("usernameLogin").value.trim();
 const password = document.getElementById("passwordLogin").value.trim();

 const snapshot = await db.collection("users").get();
 let found = false;
 snapshot.forEach(doc=>{
   const u = doc.data();
   if(u.username===username && u.password===password){
       sessionStorage.setItem("username", username);
       sessionStorage.setItem("role", u.role);
       found = true;
   }
 });
 if(found){
   loginDiv.style.display="none";
   dashboard.style.display="block";
 } else{
   alert("Username atau password salah!");
 }
});

/* CEK SESSION */
if(sessionStorage.getItem("username")){
 loginDiv.style.display="none";
 dashboard.style.display="block";
}

/* TAB */
document.querySelectorAll(".tab-btn").forEach(btn=>{
 btn.onclick=()=>{
   document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
   btn.classList.add("active");
   document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
   document.getElementById(btn.dataset.tab).style.display="block";
 };
});

/* LOGOUT */
document.getElementById("logoutBtn").addEventListener("click", ()=>{
 sessionStorage.clear();
 location.reload();
});

/* GANTI PASSWORD */
document.getElementById("gantiPassForm").addEventListener("submit", async (e)=>{
 e.preventDefault();
 const oldP = document.getElementById("oldPass").value.trim();
 const newP = document.getElementById("newPass").value.trim();
 const username = sessionStorage.getItem("username");
 if(!username) return alert("Session habis!");

 const docRef = db.collection("users").doc(username);
 const docSnap = await docRef.get();
 if(!docSnap.exists) return alert("Data user tidak ditemukan!");
 const data = docSnap.data();
 if(data.password !== oldP) return alert("Password lama salah!");
 await docRef.update({password:newP});
 alert("Password berhasil diubah!");
 document.getElementById("gantiPassForm").reset();
});

/* ----------------------------- */
/* NOPOL & PENGAJUAN sama persis seperti sebelumnya */
/* ... copy script pengajuan, riwayat, export excel dari versi sebelumnya ... */
</script>

</body>
</html>